generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  nameTh    String    @map("name_th")
  icon      String?
  color     String?
  isActive  Boolean   @default(true) @map("is_active")
  sortOrder Int       @default(0) @map("sort_order")
  createdAt DateTime  @default(now()) @map("created_at")
  requests  Request[]

  @@map("categories")
}

model JobNote {
  id               String     @id @default(uuid())
  requestId        String     @map("request_id")
  technicianId     String     @map("technician_id")
  note             String
  photos           String[]   @default([])
  materials        Json?
  timeSpentMinutes Int?       @map("time_spent_minutes")
  createdAt        DateTime   @default(now()) @map("created_at")
  request          Request    @relation(fields: [requestId], references: [id], onDelete: Cascade)
  technician       Technician @relation(fields: [technicianId], references: [id])

  @@map("job_notes")
}

model Location {
  id          String    @id @default(uuid())
  building    String
  floor       String?
  room        String?
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  requests    Request[]

  @@map("locations")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)])
  @@index([userId])
  @@index([userId, isRead])
  @@map("notifications")
}

model Rating {
  id        String   @id @default(uuid())
  requestId String   @unique @map("request_id")
  userId    String   @map("user_id")
  score     Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  request   Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@map("ratings")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([expiresAt])
  @@index([userId])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([userId])
  @@map("password_reset_tokens")
}

model RequestLog {
  id        String   @id @default(uuid())
  requestId String   @map("request_id")
  action    String
  oldStatus String?  @map("old_status")
  newStatus String?  @map("new_status")
  note      String?
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [createdBy], references: [id])
  request   Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)])
  @@index([requestId])
  @@map("request_logs")
}

model Request {
  id            String        @id @default(uuid())
  requestNumber String        @unique @map("request_number")
  userId        String        @map("user_id")
  technicianId  String?       @map("technician_id")
  categoryId    String        @map("category_id")
  locationId    String        @map("location_id")
  title         String
  description   String?
  photos        String[]      @default([])
  priority      Priority      @default(normal)
  status        RequestStatus @default(pending)
  preferredDate DateTime?     @map("preferred_date") @db.Date
  preferredTime String?       @map("preferred_time")
  assignedAt    DateTime?     @map("assigned_at")
  startedAt     DateTime?     @map("started_at")
  completedAt   DateTime?     @map("completed_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  deletedAt     DateTime?     @map("deleted_at")
  jobNotes      JobNote[]
  rating        Rating?
  requestLogs   RequestLog[]
  category      Category      @relation(fields: [categoryId], references: [id])
  location      Location      @relation(fields: [locationId], references: [id])
  technician    Technician?   @relation(fields: [technicianId], references: [id])
  user          User          @relation(fields: [userId], references: [id])

  @@index([categoryId])
  @@index([createdAt(sort: Desc)])
  @@index([locationId])
  @@index([priority])
  @@index([status])
  @@index([technicianId])
  @@index([userId])
  @@map("requests")
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model Technician {
  id           String    @id @default(uuid())
  userId       String    @unique @map("user_id")
  specialty    String[]  @default([])
  isAvailable  Boolean   @default(true) @map("is_available")
  maxJobsPerDay Int      @default(5) @map("max_jobs_per_day")
  createdAt    DateTime  @default(now()) @map("created_at")
  rating       Float?    @default(0)
  jobNotes     JobNote[]
  requests     Request[]
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("technicians")
}

model User {
  id              String         @id @default(uuid())
  email           String?        @unique
  passwordHash    String?        @map("password_hash")
  name            String
  role            Role           @default(user)
  lineId          String?        @unique @map("line_id")
  lineAccessToken String?        @map("line_access_token")
  avatarUrl       String?        @map("avatar_url")
  phone           String?
  department      String?
  isActive        Boolean        @default(true) @map("is_active")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  notifications        Notification[]
  ratings              Rating[]
  requestLogs          RequestLog[]
  requests             Request[]
  technician           Technician?
  passwordResetTokens  PasswordResetToken[]

  @@map("users")
}

enum Priority {
  low
  normal
  high
  urgent
}

enum RequestStatus {
  pending
  assigned
  accepted
  in_progress
  on_hold
  completed
  cancelled
  rejected
}

enum Role {
  user
  technician
  admin
}
